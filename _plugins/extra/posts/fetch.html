<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Dropdown</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    .iframe-container {
        display: none;
        width: 100%;
        height: 0;
        border: none;
    }

    /* Fixed sidenav, full height */
    .sidenav {
      height: 100%;
      width: 300px;
      position: fixed;
      z-index: 1;
      top: 0;
      left: 0;
      background-color: #111;
      overflow-x: hidden;
      padding-top: 20px;
    }

    /* Style the sidenav links and the dropdown button */
    .sidenav a, .dropdown-btn {
      padding: 6px 8px 6px 16px;
      text-decoration: none;
      font-size: 20px;
      color: #818181;
      display: block;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      outline: none;
    }

    /* On mouse-over */
    .sidenav a:hover, .dropdown-btn:hover {
      color: #f1f1f1;
    }

    /* Main content */
    .main {
      margin-left: 300px;
      font-size: 20px;
      padding: 0px 10px;
    }

    /* Add an active class to the active dropdown button */
    .active {
      background-color: green;
      color: white;
    }

    .activated{
      background-color: #ff2b2b;
      color: white;
    }

    /* Dropdown container (hidden by default) */
    .dropdown-container {
      display: none;
      background-color: #262626;
      padding-left: 8px;
    }

    /* Style the caret down icon */
    .fa-caret-down {
      float: right;
      padding-right: 8px;
    }

    /* Some media queries for responsiveness */
    @media screen and (max-height: 450px) {
      .sidenav {padding-top: 15px;}
      .sidenav a {font-size: 18px;}
    }
  </style>
</head>
<body>
  <iframe id="hiddenIframe" class="iframe-container"></iframe>
  
  <div class="sidenav" id="sidenav"></div>

  <div class="main">
    <h1>Fetch</h1>
      <div id='instructions'>
        <p>Click the dropdown buttons in the sidebar to show the elements that are rendered in each different post.</p>
        <p>Clicking on the posts will show a list of environment types created in that post.  </p>
        <p>Click in each <i>environment type</i> to hide/show the content.  </p>
      </div>
    <div id="elementsList"></div>
  </div>

  <script>
    const hiddenIframe = document.getElementById('hiddenIframe');
    const sidenav = document.getElementById("sidenav");
    const fetchedButtons = [];
    const results = document.getElementById('results');
    const addedClasses = [];
    const addedElements = {};
    const activeClasses = {};

    function anyEndsWith(suffix, strings) {
      return strings.some(string => string.endsWith(suffix));
    }

    function capitalizeFirstLetter(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
    function fetchElements(relativePath,button){
      if(fetchedButtons.includes(button)) return;

	    const origin = window.location.origin;
      const url = origin + relativePath;
      if(!url){
        console.log("The fuck. This is not suppose to happen....");
        return;
      }

      callback = function(iframeDoc) {
        const classNames = iframeDoc.querySelectorAll('[class]');
    
        classNamesList = [];
        // Get all class names ending with "-box"
        classNames.forEach(elem => {
          className = elem.className;
          if(typeof className == 'string'){
            // Get any that ends with '-box'
            let classes = className.split(' ').filter(str => str.endsWith("-box"));
            if(classes.length > 0) classNamesList.push(classes[0]);
          }
          });
          // Remove repeated elements
          classNamesList = classNamesList.filter((item, index, array) => array.indexOf(item) === index);
          
          content = button.nextElementSibling;
          classNamesList.forEach(elem => {
            const child = document.createElement("button");
            child.className = "dropdown-btn";
            child.textContent = capitalizeFirstLetter(elem.replace("-box",""));
            child.value = elem;
                    
            child.addEventListener("click",function(){
              if(!addedClasses.includes(elem + relativePath)){
                addElements(relativePath,elem);
                addedClasses.push(elem + relativePath);
              } else toggleElements(relativePath,elem);
              child.classList.toggle('activated');
              // Hide the instructions
              document.getElementById("instructions").style.display = 'none';
            });
            content.appendChild(child);
          });
                    
          if(!classNamesList.length){
              const child = document.createElement("button");
              child.className = "dropdown-btn";
              child.textContent = "âš  No classes in this post!";
              child.style.color = "#d60000";
              content.appendChild(child);
          }
          content.style.display = "block";
          content.classList.toggle("active");
      }
      
      iframesHandler.setOnIframeLoad(relativePath,callback); 

      fetchedButtons.push(button);
    }

    function addElements(relativePath,className){
      iframesHandler.setOnGetElemsByClassName(relativePath,className, (elements) => {
        Array.from(elements).forEach((el) => el.classList.remove('overlay'));
        if (elements.length === 0) {
            console.log(`No elements found with class "${className}"`);
        } else {
            displayElements(elements);
            addedElements[relativePath] ??= {};
            addedElements[relativePath][className] = elements;
            activeClasses[relativePath] ??= {};
            activeClasses[relativePath][className] = true;
        }
      });
    }

    function toggleElements(relativePath,className){
      const elements = addedElements[relativePath][className];
      if(activeClasses[relativePath][className]){
        Array.from(elements).forEach(el => el.style.display = 'none');
        activeClasses[relativePath][className] = false;
      }
      else {
        Array.from(elements).forEach(el => el.style.display = 'block');
        activeClasses[relativePath][className] = true;
      }
    }

    function displayElements(elements) {
         const elementsList = document.getElementById('elementsList');
         
        // Display elements followed by their respective proofs
        for (let i = 0; i < elements.length; i++){
          id = elements[i].id
          // Do not repeat repeated content
          if(id.endsWith("-repeat-repeat") || id.endsWith(":proof")) continue;

          elements[i].style.display = 'block';
          elementsList.appendChild(elements[i]);

          // Find the corresponding proof
          elemProof = elements.find(el => el.id === `${id}:proof`);
          if(elemProof){ 
            elemProof.style.display = 'block';
            elementsList.appendChild(elemProof);
          }
        }
    }

    // Get all dropdown buttons
    var dropdown = document.getElementsByClassName("dropdown-btn");

    // Loop through all dropdown buttons
    for (var i = 0; i < dropdown.length; i++) {
      dropdown[i].addEventListener("click", function() {
        // Toggle active class
        this.classList.toggle("active");
        
        // Toggle display of dropdown content
        var dropdownContent = this.nextElementSibling;
        if (dropdownContent.style.display === "block") {
          dropdownContent.style.display = "none";
        } else {
          dropdownContent.style.display = "block";
        }
      });
    }
  </script>

</body>
</html>
