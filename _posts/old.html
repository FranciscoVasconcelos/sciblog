<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Linked Pages Side by Side with Variables</title>
<style>
body {
  margin: 0;
  display: flex;
  height: 100vh;
  overflow: hidden;
}
iframe {
  width: 50%;
  height: 100%;
  border: none;
}
#left { border-right: 1px solid #ccc; }
</style>
</head>

<body>

<script>

const leftPage = "{% link index.markdown %}";
const rightPage = "{% link index.markdown %}";


function addIntercept(sourceFrame,targetFrame){
  const sourceDoc = sourceFrame.contentWindow.document;
  const targetDoc = targetFrame.contentWindow.document;
  const targetPage = new URL(targetFrame.contentWindow.location.href).pathname;
  const sourcePage = new URL(sourceFrame.contentWindow.location.href).pathname;
  
 const listener = e => {
    const a = e.target.closest('a');
    if (!a) return;

    const href = a.getAttribute('href');
    if (!href) return;

    // Get the hash from the href's url
    const parts = href.split('#');
    const match = parts.length > 1 ? '#' + parts[1] : ''; 

    if (match) {
      const targetSelector = match; 
      const target = targetDoc.getElementById(targetSelector.slice(1));  
      if (target) {
        e.preventDefault();
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // trigger :target animation by changing hash

        // Use dummy to not temporarily go to the beggining of the webpage!
        targetFrame.contentWindow.location.hash = "#dummy";
        // Force a slight delay to let browser repaint
        setTimeout(() => {
          targetFrame.contentWindow.location.hash = targetSelector;
        }, 0);
      }
    }
  }

  sourceDoc.addEventListener('click',listener );
  return listener;
}

// Set iframe sources dynamically
const leftFrame = document.getElementById('left');
const rightFrame = document.getElementById('right');
let leftListener = null;
let rightListener = null;

function isSameOrigin(targetFrame, sourceFrame) {
  try {
    const target = new URL(targetFrame.contentWindow.location.href).origin;
    const source = new URL(sourceFrame.contentWindow.location.href).origin;
    return target === source;
  } catch (e) {
    return false;
  }
}

function initialize(leftFrame,rightFrame) {
 
  // Ignore different origin
  if(!isSameOrigin(leftFrame,rightFrame)) return;

  const leftDoc = leftFrame.contentWindow.document;
  const rightDoc = rightFrame.contentWindow.document;

  if (!leftDoc || !rightDoc) return;

  if(leftListener) leftDoc.removeEventListener('click', leftListener);
  if(rightListener) rightDoc.removeEventListener('click', rightListener);
  
  leftListener = addIntercept(leftFrame,rightFrame);
  rightListener = addIntercept(rightFrame,leftFrame);
}




function DoublePagesListener(leftPage,rightPage){

  leftFrame.src = leftPage;
  rightFrame.src = rightPage;

  let leftLoaded = false;
  let rightLoaded = false;

  // Wait for both iframes to load
  leftFrame.addEventListener('load', () => {
    leftLoaded = true;
    //console.log('Left frame loaded:', leftFrame.contentWindow.location.href);
    if (leftLoaded && rightLoaded) initialize(leftFrame,rightFrame);
  });
  rightFrame.addEventListener('load', () => {
    rightLoaded = true;
    if (leftLoaded && rightLoaded) initialize(leftFrame,rightFrame);
  });
}

DoublePagesListener(leftPage,rightPage);
</script>
</body>
</html>
